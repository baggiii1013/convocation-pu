name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Allow manual triggers

env:
  NODE_ENV: production

jobs:
  # ===========================================
  # JOB 1: BUILD AND TEST
  # ===========================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üçû Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: üì¶ Install Dependencies
        run: bun install --frozen-lockfile

      - name: üîç Type Check API
        working-directory: ./apps/api
        run: bun run type-check
        continue-on-error: true

      - name: üîç Lint Web
        working-directory: ./apps/web
        run: bun run lint
        continue-on-error: true

      - name: üî® Build API
        working-directory: ./apps/api
        run: bun run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: üî® Build Web
        working-directory: ./apps/web
        run: bun run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: ‚úÖ Build Successful
        run: echo "Build completed successfully!"

  # ===========================================
  # JOB 2: DEPLOY TO SERVER
  # ===========================================
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/master'
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîë Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: üîê Sync API Environment File
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << ENDSSH
            echo "üîê Syncing API environment file..."
            cat > /home/appadmin/convocation-pu/apps/api/.env << 'ENVEOF'
          ${{ secrets.API_ENV_FILE }}
          ENVEOF
            echo "‚úì API .env synced"
          ENDSSH

      - name: üîê Sync Web Environment File
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << ENDSSH
            echo "üîê Syncing Web environment file..."
            cat > /home/appadmin/convocation-pu/apps/web/.env.production << 'ENVEOF'
          ${{ secrets.WEB_ENV_FILE }}
          ENVEOF
            echo "‚úì Web .env.production synced"
          ENDSSH

      - name: üöÄ Deploy to Server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            
            echo "üìç Navigating to project directory..."
            cd /home/appadmin/convocation-pu
            
            echo "üì• Pulling latest changes..."
            git fetch origin master
            git reset --hard origin/master
            
            echo "üì¶ Installing dependencies..."
            /home/appadmin/.bun/bin/bun install --frozen-lockfile
            
            echo "üî® Building API..."
            cd apps/api
            /home/appadmin/.bun/bin/bun run build
            cd ../..
            
            echo "üî® Building Web..."
            cd apps/web
            /home/appadmin/.bun/bin/bun run build
            cd ../..
            
            echo "üîÑ Reloading PM2 applications..."
            pm2 reload ecosystem.config.cjs --update-env
            
            echo "‚è≥ Waiting for applications to stabilize..."
            sleep 10
            
            echo "‚úÖ Checking application status..."
            pm2 status
            
            echo "üéâ Deployment completed successfully!"
          ENDSSH

      - name: üè• Health Check
        run: |
          sleep 15
          curl -f http://${{ secrets.SERVER_HOST }}/health || exit 1
          echo "Health check passed!"

  # ===========================================
  # JOB 3: NOTIFY ON FAILURE
  # ===========================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy]
    if: failure()
    
    steps:
      - name: üö® Deployment Failed
        run: |
          echo "Deployment failed! Check the logs above for details."
          # Add your notification logic here (Slack, Discord, Email, etc.)
