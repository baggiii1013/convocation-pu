name: Deploy to Production

on:
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: true

env:
  NODE_ENV: production

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Type Check API
        working-directory: ./apps/api
        run: bun run type-check
        continue-on-error: true

      - name: Lint Web
        working-directory: ./apps/web
        run: bun run lint
        continue-on-error: true

      - name: Build API
        working-directory: ./apps/api
        run: bun run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Build Web
        working-directory: ./apps/web
        run: bun run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: Build Successful
        run: echo "Build completed successfully!"

  deploy:
    name: Deploy to Production Server
    runs-on: [self-hosted, Linux, X64]
    needs: build-and-test
    if: github.ref == 'refs/heads/master'
    
    defaults:
      run:
        working-directory: /home/appadmin/convocation-pu
    
    steps:
      - name: Deploy Application
        run: |
          echo "=========================================="
          echo "Starting Zero-Downtime Deployment"
          echo "=========================================="
          
          git fetch origin master
          git reset --hard origin/master
          echo "Code updated to: $(git rev-parse --short HEAD)"
          
          echo "Installing dependencies..."
          /home/appadmin/.bun/bin/bun install --frozen-lockfile
          
          echo "Building API..."
          cd apps/api && /home/appadmin/.bun/bin/bun run build && cd ../..
          
          echo "Building Web..."
          cd apps/web && /home/appadmin/.bun/bin/bun run build && cd ../..
          
          echo "Reloading PM2..."
          pm2 reload ecosystem.config.cjs --update-env
          
          sleep 5
          pm2 status
          echo "Deployment completed!"

      - name: Health Check
        run: |
          sleep 5
          curl -sf http://localhost:3001/api/v1/health && echo "API OK" || echo "API Warning"
          curl -sf -o /dev/null http://localhost:3000/ && echo "Web OK" || echo "Web Warning"
